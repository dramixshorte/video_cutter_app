# دليل الأذونات والخادم وحل أخطاء الرفع والقص

## 1. الأذونات (Android)

### لماذا ظهر Permission denied؟
- كان التطبيق يكتب مباشرة في `/storage/emulated/0/Download/DramaxShort`.
- في Android 10+ مع Scoped Storage & MIUI (شاومي) قد تُرفض الكتابة حتى مع `MANAGE_EXTERNAL_STORAGE` بسبب تشديد النظام أو عدم منح الإذن فعلياً.
- الآن الكود ينشئ مجلد خاص بالتطبيق (App-Specific External) داخل:
  `/storage/emulated/0/Android/data/<package>/files/DramaxShortParts`
  وهذا لا يحتاج لإذن "إدارة كل الملفات".
- إذا فشل، يسقط (fallback) إلى `ApplicationDocumentsDirectory` الداخلي.
- قبل القص يتم اختبار الكتابة (Preflight) بإنشاء وحذف ملف صغير. إذا فشل سترى رسالة عربية واضحة.

### ما الذي يجب طلبه من الأذونات؟
| الإصدار | الفيديو/الصورة | التخزين العام | ملاحظات |
|---------|----------------|---------------|---------|
| <= Android 12 | `Permission.storage` (قد تُرجع Granted افتراضياً) | تجنّب `MANAGE_EXTERNAL_STORAGE` إن لم تحفظ بمجلد عام | استخدم مجلد التطبيق دائماً |
| Android 13 و 14 | `Permission.videos`, `Permission.photos` فقط (للملفات المختارة) | لا حاجة لـ STORAGE العام | لا تطلب MANAGE إلا إذا ستتعامل مع مجلدات عامة متعددة |
| Android 15 (مبكر) | نفس 13+ | قد تظهر حوارات جديدة للخصوصية | 

### أجهزة شاومي / ريدمي
- MIUI أحياناً تعطل منح "إدارة كل الملفات" وتحتاج تفعيل يدوي داخل **الإعدادات > الخصوصية > إدارة كل الملفات**.
- الحل الذي اعتمدناه (App-Specific External) يزيل الحاجة لذلك.

### ماذا لو أردت لاحقاً التصدير إلى Downloads؟
- أضف زر "تصدير" يستخدم SAF (Storage Access Framework) أو MediaStore لنسخ الملفات النهائية إلى مجلد عام بعد النجاح.

## 2. تحسينات القص (FFmpeg)
- إضافة Preflight: إن فشلت الكتابة سترجع رسالة `لا يمكن الكتابة في مجلد الإخراج` بدلاً من رسالة FFmpeg الطويلة.
- تحليل الأخطاء: إذا وجد `Permission denied`, `Invalid data`, `No such file` يتم إرجاع رسالة عربية مختصرة.
- عدم الاعتماد على مجلد غير مضمون الصلاحيات.

## 3. الرفع (Dio / 502)
### ماذا يعني 502؟
- غالباً Nginx (أو Cloudflare) لم يستطع الحصول على استجابة من PHP-FPM ضمن المهلة، أو خادم الوسيط رجع خطأ.

### تحسينات في الكود
- زيادة المحاولات إلى 5 مع Backoff أُسّي: 2,4,8,16,32 ثانية.
- عدم إعادة المحاولة لأخطاء 4xx (عدا 429). 413 تعطي رسالة واضحة بتقليل الحجم.
- رسائل عربية أوضح.

### إعدادات خادم مقترحة (Nginx + PHP-FPM)
ضع في `nginx.conf` أو موقع الـ server:
```
client_max_body_size 1024M;           # حجم أقصى للملف (عدّل حسب الحاجة)
proxy_read_timeout 600s;              # لو يوجد Proxy أمام PHP
fastcgi_read_timeout 600s;
fastcgi_buffers 32 32k;
fastcgi_buffer_size 64k;
```
في `php.ini`:
```
upload_max_filesize = 1024M
post_max_size = 1024M
max_execution_time = 600
max_input_time = 600
memory_limit = 1024M   # حسب الذاكرة المتاحة
```
أعد تشغيل الخدمات بعد التعديل.

### مراقبة السجلات
- سجلات Nginx: `/var/log/nginx/error.log`
- سجلات PHP-FPM: غالباً `/var/log/php8.x-fpm.log`
- أضف Logging في `api.php` قبل/بعد move_uploaded_file لمعرفة الانقطاعات.

### اقتراحات إضافية لتخفيف الضغط
- (اختياري) تنفيذ Transcode إلى Bitrate أقل قبل الرفع لتقليل حجم كل جزء.
- (اختياري) استخدام رفع مجزأ (chunked) لاحقاً: تقسيم الحلقة إلى أجزاء 5MB وجمعها في الخادم.

## 4. اختبار شامل بعد التحديث
1. امسح التطبيق من الجهاز (للتأكد من الأذونات من البداية).
2. ثبت نسخة Debug جديدة.
3. افتح التطبيق، اختر فيديو كبير (2+ جيجا) – تأكد أن رسالة الأذونات لا تطلب إدارة شاملة.
4. ابدأ القص – يجب أن يظهر التقدم بدون أخطاء Permission.
5. تحقق من المسار عبر (Android Studio Device File Explorer) في:
   `Android/data/<package>/files/DramaxShortParts`
6. ارفع الحلقات – راقب إن حصل 502: الكود سيعيد المحاولات وخلالها يظهر التقدم. إذا فشل بعد المحاولات افحص سجلات الخادم.
7. جرّب إطفاء الانترنت مؤقتاً أثناء رفع حلقة: يجب أن ترى تراجع ثم إعادة المحاولة.
8. تأكد من حذف الأجزاء محلياً بعد اكتمال الرفع (الميزة الحالية تحاول حذفها تلقائياً).

## 5. استكشاف مشاكل متبقية
| العرض | السبب المحتمل | الحل |
|-------|---------------|------|
| لا يبدأ القص | Preflight فشل | تحقق من الأذونات أو مساحة التخزين |
| 502 متكرر سريع | قيود خادم أو انقطاع | راجع إعدادات Nginx/PHP أعلاه |
| 413 | الحجم أكبر من إعداد الخادم | ارفع القيم أو قلل المدة / bitrate |
| عمليات بطيئة جداً | I/O للجهاز أو CPU ضعيف | جرّب تقليل عدد الأجزاء (مدة أطول) |

## 6. خطوات لاحقة (مستقبلية)
- إضافة زر تصدير إلى Downloads (MediaStore).
- دعم رفع متوازي محدود (2 حلقات) مع Queue.
- ضغط/Transcode للحلقات قبل الرفع لتقليل الحجم.

---
تم إعداد هذا الدليل لشرح التغييرات الجذرية التي تم تنفيذها ولمعالجة الأخطاء المعروضة في الصور (Permission denied و 502).
